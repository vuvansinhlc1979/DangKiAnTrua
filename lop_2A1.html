<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒêƒÉng K√Ω C∆°m Tr∆∞a - L·ªõp 3A1</title>
    <style>
        /* ===================================================================
         * 1. STYLES C∆† B·∫¢N V√Ä B·ªê C·ª§C
         * =================================================================== */
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: #f4f7f6; 
            color: #333; 
            margin: 0; 
            padding: 20px; 
        }
        .container { 
            max-width: 900px; 
            margin: 0 auto; 
            padding: 25px; 
            background-color: #fff; 
            border-radius: 15px; 
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15); 
        }
        h1 { 
            text-align: center; 
            color: #007bff; 
            margin-bottom: 30px; 
            border-bottom: 2px solid #e9ecef; 
            padding-bottom: 10px; 
        }
        .summary {
            text-align: center; 
            margin-bottom: 25px; 
            font-size: 1.2em; 
            font-weight: bold;
            padding: 15px; 
            border-radius: 8px; 
            background-color: #e9f7ff; 
            color: #0056b3;
        }
        .student-list {
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 15px; 
            margin-bottom: 40px;
        }
        .student-item {
            padding: 18px 10px; 
            border-radius: 10px; 
            cursor: pointer; 
            text-align: center;
            font-weight: bold; 
            transition: all 0.3s ease; 
            user-select: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* Tr·∫°ng th√°i m·∫∑c ƒë·ªãnh: KH√îNG ƒÇN (M√†u ƒë·ªè nh·∫°t) */
        .student-item.not-eating {
            background-color: #fcebeb; 
            color: #cc0000; 
            border: 2px solid #f0a3a3;
        }

        /* Tr·∫°ng th√°i ƒê√É ƒëƒÉng k√Ω: ƒÇN (M√†u xanh l√° nh·∫°t, b·∫≠t s√°ng) */
        .student-item.eating {
            background-color: #e6ffe6; 
            color: #006400; 
            border: 3px solid #00c800;
            transform: scale(1.02); 
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
        }

        /* ===================================================================
         * 2. STYLES N√öT H√ÄNH ƒê·ªòNG
         * =================================================================== */
        .action-container { display: flex; gap: 10px; }
        .action-button {
            padding: 18px; 
            font-size: 18px; 
            border: none; 
            border-radius: 10px;
            cursor: pointer; 
            transition: background-color 0.3s; 
            font-weight: bold;
        }
        #submit-btn { flex-grow: 3; background-color: #28a745; color: white; }
        #submit-btn:hover:not(:disabled) { background-color: #218838; }
        #submit-btn:disabled { background-color: #ccc; cursor: not-allowed; }

        #edit-btn { flex-grow: 1; background-color: #ffc107; color: #333; display: none; }
        #edit-btn:hover:not(:disabled) { background-color: #e0a800; }

        #reset-btn { flex-grow: 1; background-color: #dc3545; color: white; }
        #reset-btn:hover:not(:disabled) { background-color: #c82333; }
        
        /* ===================================================================
         * 3. STYLES TR·∫†NG TH√ÅI (MUA/KH√ìA)
         * =================================================================== */
        .editing-mode .student-item { opacity: 1; pointer-events: auto; }
        .locked-mode .student-item { opacity: 0.7; pointer-events: none; }
        
        /* Th√¥ng b√°o kh√≥a h·ªá th·ªëng - CH·ªà HI·ªÜN KHI H·∫æT GI·ªú */
        .lock-message {
            text-align: center; 
            color: #dc3545; 
            font-weight: bold; 
            font-size: 1.4em; 
            margin: 40px 0; 
            padding: 25px; 
            background-color: #f8d7da; 
            border-radius: 12px;
            border: 3px solid #dc3545;
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.2);
            display: none; 
        }
        
        .lock-icon {
            font-size: 4em;
            color: #dc3545;
            margin-bottom: 20px;
        }
        
        /* ===================================================================
         * 4. CUSTOM DIALOG STYLES (Chung cho Prompt, Alert, Confirm)
         * =================================================================== */
        #custom-dialog-overlay, #custom-alert-overlay, #custom-confirm-overlay {
            display: none; 
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7); 
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(3px); 
        }

        #custom-dialog-box, #custom-alert-box, #custom-confirm-box {
            background: linear-gradient(135deg, #ffffff, #f0f0f5);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            width: 90%;
            text-align: center;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        #dialog-title, #alert-title, #confirm-title {
            color: #007bff;
            font-size: 1.5em;
            margin-bottom: 10px;
        }

        #dialog-message, #alert-message, #confirm-message {
            color: #555;
            margin-bottom: 20px;
        }
        
        /* N√∫t chung */
        .dialog-actions {
            display: flex;
            justify-content: space-around;
            gap: 10px;
        }
        .dialog-button-style {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s, transform 0.1s;
            flex-grow: 1;
        }

        /* M√†u n√∫t OK/X√°c nh·∫≠n (Chung cho Prompt, Alert v√† Confirm) */
        #dialog-ok-btn, #confirm-ok-btn, #alert-ok-btn {
            background-color: #007bff;
            color: white;
        }
        #dialog-ok-btn:hover, #confirm-ok-btn:hover, #alert-ok-btn:hover {
            background-color: #0056b3;
            transform: translateY(-1px);
        }

        /* M√†u n√∫t H·ªßy (Chung cho Prompt v√† Confirm) */
        #dialog-cancel-btn, #confirm-cancel-btn {
            background-color: #e9ecef;
            color: #333;
        }
        #dialog-cancel-btn:hover, #confirm-cancel-btn:hover {
            background-color: #ced4da;
            transform: translateY(-1px);
        }

        /* Style cho Input (ch·ªâ d√πng cho Prompt) */
        #dialog-input {
            width: calc(100% - 20px);
            padding: 12px;
            margin-bottom: 25px;
            border: 2px solid #ccc;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 1.1em;
            transition: border-color 0.3s;
        }

        #dialog-input:focus {
            border-color: #007bff;
            outline: none;
            box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
        }
    </style>
</head>
<body class="editing-mode">
    <div class="container">
        <h1>üç± ƒêƒÉng K√Ω C∆°m Tr∆∞a - L·ªõp 3A1</h1>
        
        <div id="lock-message" class="lock-message">
            <div class="lock-icon">‚õî</div>
            H·ªÜ TH·ªêNG ƒê√É T·ª∞ ƒê·ªòNG KH√ìA ƒêƒÇNG K√ù (Sau 7h30 h√†ng ng√†y)
            <p style="color: #666; font-size: 0.8em; margin-top: 15px;">
                ‚è∞ Th·ªùi gian ƒëƒÉng k√Ω ƒë√£ k·∫øt th√∫c. Vui l√≤ng quay l·∫°i l√∫c 12h tr∆∞a h√†ng ng√†y.
            </p>
        </div>
        
        <div id="main-content">
            <div class="summary">
                T·ªïng s·ªë h·ªçc sinh: <span id="total-students">...</span> |
                S·ªë l∆∞·ª£ng ƒëƒÉng k√Ω ƒÉn: <span id="eating-count" style="color: green;">0</span> |
                S·ªë l∆∞·ª£ng kh√¥ng ƒÉn: <span id="not-eating-count" style="color: red;">...</span>
            </div>
            
            <div class="student-list" id="student-list">
            </div>
            
            <div class="action-container">
                <button id="submit-btn" class="action-button">‚úÖ G·ª¨I L·∫¶N ƒê·∫¶U / C·∫¨P NH·∫¨T (GVCN)</button>
                <button id="reset-btn" class="action-button">üîÑ ƒê·∫∂T L·∫†I</button>
                <button id="edit-btn" class="action-button">‚úèÔ∏è S·ª¨A ƒêƒÇNG K√ù</button>
            </div>
        </div>
    </div>
    
    <div id="custom-dialog-overlay">
        <div id="custom-dialog-box">
            <h3 id="dialog-title">üîë S·ª¨A ƒêƒÇNG K√ù C∆†M TR∆ØA</h3>
            <p id="dialog-message">Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u Gi√°o vi√™n ch·ªß nhi·ªám ƒë·ªÉ s·ª≠a ƒë·ªïi danh s√°ch ƒëƒÉng k√Ω.</p>
            <input type="password" id="dialog-input" placeholder="Nh·∫≠p m·∫≠t kh·∫©u t·∫°i ƒë√¢y..." />
            <div id="dialog-actions" class="dialog-actions">
                <button id="dialog-ok-btn" class="dialog-button-style">X√°c nh·∫≠n</button>
                <button id="dialog-cancel-btn" class="dialog-button-style">H·ªßy b·ªè</button>
            </div>
        </div>
    </div>
    
    <div id="custom-alert-overlay" style="display: none;">
        <div id="custom-alert-box">
            <h3 id="alert-title">Th√¥ng B√°o</h3>
            <p id="alert-message"></p>
            <button id="alert-ok-btn" class="dialog-button-style">ƒê√£ Hi·ªÉu</button>
        </div>
    </div>

    <div id="custom-confirm-overlay" style="display: none;">
        <div id="custom-confirm-box">
            <h3 id="confirm-title">X√°c Nh·∫≠n H√†nh ƒê·ªông</h3>
            <p id="confirm-message"></p>
            <div id="confirm-actions" class="dialog-actions">
                <button id="confirm-ok-btn" class="dialog-button-style">X√°c Nh·∫≠n</button>
                <button id="confirm-cancel-btn" class="dialog-button-style">H·ªßy B·ªè</button>
            </div>
        </div>
    </div>
    <script>
        // ===================================================================
        // C·∫§U H√åNH 
        // ===================================================================
        const CLASS_NAME = "3A1";
        const EDIT_PASSWORD = "giaphu2";
        const TODAY_DATE_STRING = new Date().toLocaleDateString('vi-VN');

        // Key Local Storage
        const STORAGE_KEY_PREFIX = 'lop3A1_registration_data_'; 
        const CURRENT_STORAGE_KEY = STORAGE_KEY_PREFIX + TODAY_DATE_STRING;

        const LAST_SENT_KEY_PREFIX = 'lop3A1_last_sent_'; 
        const CURRENT_LAST_SENT_KEY = LAST_SENT_KEY_PREFIX + TODAY_DATE_STRING;
        
        // Th·ªùi gian ƒëƒÉng k√Ω: T·ª´ 12h00 tr∆∞a h√¥m tr∆∞·ªõc ƒë·∫øn 7h30 s√°ng h√¥m sau
        const UNLOCK_HOUR = 12; // Gi·ªù m·ªü: 12h00 tr∆∞a h√¥m tr∆∞·ªõc
        const UNLOCK_MINUTE = 0;
        const LOCK_HOUR = 7;    // Gi·ªù kh√≥a: 7h30 s√°ng h√¥m nay
        const LOCK_MINUTE = 30;

        // URL c·ªßa Google Apps Script Web App
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyDxgCYRXo4FQXOKd1Kb2f-TkOtujMsSRK-JODz1Ka7WwOzXQ0ca5tjKM0uu8wrgpxF/exec";
        
        // 1. DANH S√ÅCH H·ªåC SINH
        const students = [
    { id: 1, name: "Nguy·ªÖn Ng·ªçc Ho√†i An" },
    { id: 2, name: "V≈© Ng·ªçc Minh An" },
    { id: 3, name: "Tr·∫ßn V≈© T√∫ Anh" },
    { id: 4, name: "V≈© T√∫ Anh" },
    { id: 5, name: "Ph·∫°m Ng·ªçc √Ånh" },
    { id: 6, name: "Nguy·ªÖn Qu·ªëc B·∫£o" },
    { id: 7, name: "V≈© Thanh B√¨nh" },
    { id: 8, name: "Nguy·ªÖn B·∫£o Minh Ch√¢u" },
    { id: 9, name: "Nguy·ªÖn Nh·∫•t Duy" },
    { id: 10, name: "Ho√†ng Linh ƒêan" },
    { id: 11, name: "L√™ Ng·ªçc T√¢m ƒêan" },
    { id: 12, name: "Nguy·ªÖn Thanh H√†" },
    { id: 13, name: "Tr·∫ßn Tu·ªá H√¢n" },
    { id: 14, name: "V≈© Huy Ho√†ng" },
    { id: 15, name: "Ng√¥ VƒÉn Kh·∫£i" },
    { id: 16, name: "Ho√†ng Minh Khang" },
    { id: 17, name: "Nguy·ªÖn Gia Kh√°nh" },
    { id: 18, name: "Tr·∫ßn Th√πy Linh" },
    { id: 19, name: "Nguy·ªÖn H∆∞∆°ng Ly" },
    { id: 20, name: "L√™ H·∫£i M·∫´n" },
    { id: 21, name: "Ph·∫°m L·ª•c Th·∫£o My" },
    { id: 22, name: "L∆∞u Ho√†ng Nh·∫≠t Nam" },
    { id: 23, name: "ƒê·ªó Minh Nh·∫≠t" },
    { id: 24, name: "Nguy·ªÖn An Nhi√™n" },
    { id: 25, name: "ƒê√†o Nh√£ Ph∆∞∆°ng" },
    { id: 26, name: "Nguy·ªÖn Minh Ph∆∞∆°ng" },
    { id: 27, name: "Nguy·ªÖn Ho√†ng ƒê·ªó Quy√™n" },
    { id: 28, name: "ƒêinh Qu·ªëc Th√°i" },
    { id: 29, name: "Nguy·ªÖn Minh Thanh" },
    { id: 30, name: "Nguy·ªÖn Ph∆∞∆°ng Th√πy" },
    { id: 31, name: "ƒê·ªó Anh Th∆∞" },
    { id: 32, name: "VƒÉn Anh Tu·∫•n" },
    { id: 33, name: "ƒê√†o V≈© Minh T√πng" },
    { id: 34, name: "ƒêinh Kh√°nh Vy" },
    { id: 35, name: "Ph·∫°m Minh Kh√¥i" },
    { id: 36, name: "Nguy·ªÖn Ng·ªçc B·∫£o Tr√¢m" },
    { id: 37, name: "ƒê·ªó H·∫£i Y·∫øn" }, // ƒê√£ th√™m d·∫•u ph·∫©y
    { id: 38, name: "Nguy·ªÖn Ho√†i An" }, // ƒê√£ th√™m d·∫•u ph·∫©y
    { id: 39, name: "ƒê·ªó Ph·∫°m B·∫£o An" }
];
        
        // 2. KH·ªûI T·∫†O C√ÅC BI·∫æN DOM V√Ä D·ªÆ LI·ªÜU
        const studentListDiv = document.getElementById('student-list');
        const submitButton = document.getElementById('submit-btn');
        const resetButton = document.getElementById('reset-btn'); 
        const editButton = document.getElementById('edit-btn');
        const eatingCountSpan = document.getElementById('eating-count');
        const notEatingCountSpan = document.getElementById('not-eating-count');
        const totalStudentsSpan = document.getElementById('total-students');
        const body = document.body;
        const lockMessage = document.getElementById('lock-message');
        const mainContent = document.getElementById('main-content');
        let registrationData = {};
        
        totalStudentsSpan.textContent = students.length;

        // ===================================================================
        // H√ÄM CH·ª®C NƒÇNG (CUSTOM DIALOGS)
        // ===================================================================

        // H√†m: Hi·ªÉn th·ªã h·ªôp tho·∫°i Prompt t√πy ch·ªânh (Thay th·∫ø prompt())
        function showCustomPrompt() {
            return new Promise(resolve => {
                const overlay = document.getElementById('custom-dialog-overlay');
                const input = document.getElementById('dialog-input');
                const okBtn = document.getElementById('dialog-ok-btn');
                const cancelBtn = document.getElementById('dialog-cancel-btn');
                
                overlay.style.display = 'flex';
                input.value = ''; 
                input.focus(); 

                const closeDialog = (result) => {
                    overlay.style.display = 'none';
                    okBtn.onclick = null;
                    cancelBtn.onclick = null;
                    input.onkeyup = null;
                    resolve(result);
                };
                
                okBtn.onclick = () => closeDialog(input.value);
                cancelBtn.onclick = () => closeDialog(null);

                input.onkeyup = (event) => {
                    if (event.key === 'Enter') {
                        closeDialog(input.value);
                    }
                };
            });
        }
        
        // H√†m: Hi·ªÉn th·ªã h·ªôp tho·∫°i Alert t√πy ch·ªânh (Thay th·∫ø alert())
        function showCustomAlert(message, title = "Th√¥ng B√°o") {
            return new Promise(resolve => {
                const overlay = document.getElementById('custom-alert-overlay');
                const titleEl = document.getElementById('alert-title');
                const messageEl = document.getElementById('alert-message');
                const okBtn = document.getElementById('alert-ok-btn');
                
                titleEl.textContent = title;
                messageEl.textContent = message;
                overlay.style.display = 'flex';

                okBtn.onclick = () => {
                    overlay.style.display = 'none';
                    okBtn.onclick = null;
                    resolve(true); 
                };
            });
        }

        // H√†m: Hi·ªÉn th·ªã h·ªôp tho·∫°i Confirm t√πy ch·ªânh (Thay th·∫ø confirm())
        function showCustomConfirm(message, title = "X√°c Nh·∫≠n H√†nh ƒê·ªông") {
            return new Promise(resolve => {
                const overlay = document.getElementById('custom-confirm-overlay');
                const titleEl = document.getElementById('confirm-title');
                const messageEl = document.getElementById('confirm-message');
                const okBtn = document.getElementById('confirm-ok-btn');
                const cancelBtn = document.getElementById('confirm-cancel-btn');

                titleEl.textContent = title;
                messageEl.textContent = message;
                overlay.style.display = 'flex';

                const closeDialog = (result) => {
                    overlay.style.display = 'none';
                    okBtn.onclick = null;
                    cancelBtn.onclick = null;
                    resolve(result); 
                };

                okBtn.onclick = () => closeDialog(true);
                cancelBtn.onclick = () => closeDialog(false);
            });
        }

        // ===================================================================
        // H√ÄM CH·ª®C NƒÇNG (LOGIC ·ª®NG D·ª§NG)
        // ===================================================================

        // H√†m 1: Ki·ªÉm tra xem ƒë√£ qua gi·ªù kh√≥a ch∆∞a (h·∫øt h·∫°n: 7h30) HO·∫∂C ch∆∞a ƒë·∫øn gi·ªù m·ªü (ch∆∞a b·∫Øt ƒë·∫ßu: 12h tr∆∞a)
        function isLockedByTime() {
            const now = new Date();
            const currentHour = now.getHours();
            const currentMinute = now.getMinutes();
            
            // ƒê√£ qua 7h30 s√°ng
            const isPastLockTime = (currentHour > LOCK_HOUR) || 
                                   (currentHour === LOCK_HOUR && currentMinute >= LOCK_MINUTE);

            // Ch∆∞a ƒë·∫øn 12h00 tr∆∞a
            const isTooEarly = (currentHour < UNLOCK_HOUR) || 
                               (currentHour === UNLOCK_HOUR && currentMinute < UNLOCK_MINUTE);
                               
            // H·ªá th·ªëng b·ªã kh√≥a n·∫øu: ƒê√É QUA 7h30 V√Ä CH∆ØA ƒê·∫æN 12h00 TR∆ØA
            return isPastLockTime && isTooEarly; 
        }

        // H√†m 2: √Åp d·ª•ng kh√≥a ho√†n to√†n - CH·ªà KHI H·∫æT GI·ªú
        function applyFullLock() {
            body.classList.remove('editing-mode');
            body.classList.add('locked-mode');
            
            mainContent.style.display = 'none';
            lockMessage.style.display = 'block';
            
            submitButton.disabled = true;
            editButton.style.display = 'none';
            resetButton.style.display = 'none';
        }

        // H√†m 3: Kh·ªüi t·∫°o danh s√°ch h·ªçc sinh tr√™n giao di·ªán
        function initializeStudents() {
            if (isLockedByTime()) {
                applyFullLock();
                return;
            }

            // T·∫£i tr·∫°ng th√°i ƒëƒÉng k√Ω ƒë√£ l∆∞u t·ª´ Local Storage
            const savedDataJSON = localStorage.getItem(CURRENT_STORAGE_KEY);
            let savedRegistrationData = {};
            if (savedDataJSON) {
                try {
                    savedRegistrationData = JSON.parse(savedDataJSON);
                } catch (e) {}
            }

            students.forEach(student => {
                const item = document.createElement('div');
                // Chuy·ªÉn student.id th√†nh string ƒë·ªÉ so s√°nh
                const isEating = savedRegistrationData[student.id] === true || savedRegistrationData[student.id.toString()] === true;
                
                item.className = 'student-item ' + (isEating ? 'eating' : 'not-eating');
                item.textContent = student.name;
                item.dataset.id = student.id;
                item.onclick = toggleRegistration;
                studentListDiv.appendChild(item);
                
                registrationData[student.id] = isEating;
            });
            updateSummary();
            
            // Ki·ªÉm tra tr·∫°ng th√°i (ƒë√£ g·ª≠i hay ch∆∞a)
            checkSubmissionStatus();
        }

        // H√†m 4: Ki·ªÉm tra tr·∫°ng th√°i ƒë√£ g·ª≠i
        function checkSubmissionStatus() {
            const lastSent = localStorage.getItem(CURRENT_LAST_SENT_KEY);
            if (lastSent) {
                // ƒê√É G·ª¨I: Kh√≥a nh·∫π, hi·ªán n√∫t S·ª¨A
                lockInterface(); 
            } else {
                // CH∆ØA G·ª¨I: M·ªü ho√†n to√†n
                unlockInterface();
                submitButton.textContent = "‚úÖ G·ª¨I L·∫¶N ƒê·∫¶U / C·∫¨P NH·∫¨T (GVCN)";
            }
        }
        
        // H√†m 5: ƒê·ªïi tr·∫°ng th√°i khi b·∫•m v√†o t√™n
        function toggleRegistration(event) {
            if (body.classList.contains('locked-mode')) return;
            
            const item = event.target;
            const studentId = parseInt(item.dataset.id);

            const isEating = item.classList.toggle('eating');
            item.classList.toggle('not-eating', !isEating);

            registrationData[studentId] = isEating;
            updateSummary();
            
            // L∆∞u ngay l·∫≠p t·ª©c v√†o Local Storage khi thay ƒë·ªïi
            localStorage.setItem(CURRENT_STORAGE_KEY, JSON.stringify(registrationData));
        }

        // H√†m 6: C·∫≠p nh·∫≠t t√≥m t·∫Øt s·ªë l∆∞·ª£ng 
        function updateSummary() {
            const eatingCount = Object.values(registrationData).filter(status => status).length;
            const notEatingCount = students.length - eatingCount;
            
            eatingCountSpan.textContent = eatingCount;
            notEatingCountSpan.textContent = notEatingCount;
        }

        // H√†m 7: Kh√≥a giao di·ªán (sau khi g·ª≠i) - CH·ªà KH√ìA NH·∫∏
        function lockInterface() {
            body.classList.remove('editing-mode');
            body.classList.add('locked-mode');
            submitButton.disabled = true;
            submitButton.textContent = "ƒê√É G·ª¨I XONG - B·∫•m S·ª¨A ƒë·ªÉ thay ƒë·ªïi";
            editButton.style.display = 'inline-block'; // HI·ªÜN N√öT S·ª¨A
            resetButton.style.display = 'inline-block';
        }

        // H√†m 8: M·ªü kh√≥a giao di·ªán (cho ph√©p S·ª¨A)
        function unlockInterface() {
            body.classList.remove('locked-mode');
            body.classList.add('editing-mode');
            submitButton.disabled = false;
            submitButton.textContent = "‚úÖ G·ª¨I L·∫¶N ƒê·∫¶U / C·∫¨P NH·∫¨T (GVCN)";
            editButton.style.display = 'none';
            resetButton.style.display = 'inline-block';
        }
        
        // H√†m 9: ƒê·∫∑t l·∫°i tr·∫°ng th√°i (S·ª≠ d·ª•ng Custom Confirm/Alert)
        async function resetRegistration() {
            if (isLockedByTime()) {
                await showCustomAlert(`‚ùå ƒê√£ h·∫øt th·ªùi gian ƒëƒÉng k√Ω (sau ${LOCK_HOUR}h${LOCK_MINUTE}). Kh√¥ng th·ªÉ ƒê·∫∂T L·∫†I.`, "L·ªói Th·ªùi Gian");
                return;
            }

            const confirmed = await showCustomConfirm(
                "B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒê·∫∂T L·∫†I to√†n b·ªô danh s√°ch ƒëƒÉng k√Ω v·ªÅ tr·∫°ng th√°i M·∫∂C ƒê·ªäNH (T·∫•t c·∫£ KH√îNG ƒÇN) kh√¥ng? Thao t√°c n√†y s·∫Ω x√≥a d·ªØ li·ªáu ƒë√£ l∆∞u tr·ªØ.",
                "X√°c Nh·∫≠n ƒê·∫∑t L·∫°i"
            );
            if (!confirmed) return;
            
            localStorage.removeItem(CURRENT_STORAGE_KEY);
            localStorage.removeItem(CURRENT_LAST_SENT_KEY);

            students.forEach(student => {
                registrationData[student.id] = false;
            });

            const studentItems = studentListDiv.querySelectorAll('.student-item');
            studentItems.forEach(item => {
                item.classList.remove('eating');
                item.classList.add('not-eating');
            });

            updateSummary();
            unlockInterface();
            await showCustomAlert("‚úÖ ƒê·∫∑t l·∫°i th√†nh c√¥ng. Vui l√≤ng b·∫•m G·ª¨I ƒë·ªÉ ho√†n t·∫•t.", "Th√†nh C√¥ng");
        }

        // H√†m 10: X·ª≠ l√Ω n√∫t G·ª¨I (S·ª≠ d·ª•ng Custom Confirm/Alert)
        submitButton.onclick = async () => {
            if (isLockedByTime()) {
                await showCustomAlert(`‚ùå ƒê√£ h·∫øt th·ªùi gian ƒëƒÉng k√Ω (sau ${LOCK_HOUR}h${LOCK_MINUTE}). Kh√¥ng th·ªÉ g·ª≠i.`, "L·ªói Th·ªùi Gian");
                applyFullLock();
                return;
            }

            const confirmed = await showCustomConfirm(
                "B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën G·ª¨I/C·∫¨P NH·∫¨T d·ªØ li·ªáu ƒëƒÉng k√Ω b·ªØa tr∆∞a n√†y kh√¥ng? D·ªØ li·ªáu c≈© (n·∫øu c√≥) s·∫Ω b·ªã ghi ƒë√®.",
                "X√°c Nh·∫≠n G·ª≠i D·ªØ Li·ªáu"
            );
            if (!confirmed) return;

            const eatingStudents = students
                .filter(student => registrationData[student.id])
                .map(student => student.name);
            
            const notEatingStudents = students
                .filter(student => !registrationData[student.id])
                .map(student => student.name);

            const finalData = {
                api_key: "123456789", 
                class_name: CLASS_NAME, 
                date: new Date().toLocaleDateString('vi-VN'),
                eating_count: eatingStudents.length, 
                not_eating_count: notEatingStudents.length, 
                eating_list: eatingStudents,
            };
            
            submitButton.disabled = true;
            submitButton.textContent = "ƒêANG G·ª¨I D·ªÆ LI·ªÜU...";
            
            fetch(WEB_APP_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(finalData)
            })
            .then(response => {
                // X·ª≠ l√Ω th√†nh c√¥ng
                showCustomAlert(`‚úÖ ƒê√£ g·ª≠i/c·∫≠p nh·∫≠t ƒëƒÉng k√Ω th√†nh c√¥ng cho ${CLASS_NAME}.\nT·ªïng s·ªë su·∫•t ƒÉn: ${finalData.eating_count}.`, "G·ª≠i Th√†nh C√¥ng");
                lockInterface(); 
                localStorage.setItem(CURRENT_LAST_SENT_KEY, new Date().toISOString());
            })
            .catch(error => {
                console.error('L·ªói khi g·ª≠i d·ªØ li·ªáu:', error);
                showCustomAlert('‚ùå L·ªói x·∫£y ra khi g·ª≠i ƒëƒÉng k√Ω. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi v√† th·ª≠ l·∫°i.', "L·ªói K·∫øt N·ªëi");
                unlockInterface();
            });
        };

        // ===================================================================
        // G√ÅN S·ª∞ KI·ªÜN V√Ä KH·ªûI T·∫†O
        // ===================================================================

        // S·ª± ki·ªán cho n√∫t RESET
        resetButton.onclick = resetRegistration; 

        // S·ª± ki·ªán cho n√∫t S·ª¨A (D√πng Custom Prompt/Alert)
        editButton.onclick = async () => {
            if (isLockedByTime()) {
                await showCustomAlert(`‚ùå ƒê√£ h·∫øt th·ªùi gian ƒëƒÉng k√Ω (sau ${LOCK_HOUR}h${LOCK_MINUTE}). Kh√¥ng th·ªÉ s·ª≠a ƒë·ªïi th√™m.`, "L·ªói Th·ªùi Gian");
                return; 
            }

            const passwordAttempt = await showCustomPrompt();
            
            if (passwordAttempt === EDIT_PASSWORD) {
                unlockInterface(); 
            } else if (passwordAttempt !== null) {
                await showCustomAlert("‚ùå M·∫≠t kh·∫©u kh√¥ng ch√≠nh x√°c. Ch·ªâ Gi√°o vi√™n ch·ªß nhi·ªám m·ªõi c√≥ quy·ªÅn s·ª≠a ƒë·ªïi.", "L·ªói Truy C·∫≠p");
            }
        };

        // Kh·ªüi t·∫°o ·ª©ng d·ª•ng
        initializeStudents();

        // Ki·ªÉm tra l·∫°i m·ªói ph√∫t ƒë·ªÉ ƒë·∫£m b·∫£o kh√≥a ƒë√∫ng th·ªùi ƒëi·ªÉm 7h30 s√°ng
        setInterval(() => {
            if (isLockedByTime() && mainContent.style.display !== 'none') {
                applyFullLock();
            }
        }, 60000); 

    </script>
</body>
</html>
